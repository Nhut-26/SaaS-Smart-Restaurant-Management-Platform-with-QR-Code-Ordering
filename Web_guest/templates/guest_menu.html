<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>S2O • Guest QR Menu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .menu-card img { object-fit: cover; height: 130px; }
    .sticky-actions { position: sticky; bottom: 0; background: white; padding: 12px; border-top: 1px solid #eee; }
    .small-muted { font-size: .9rem; color: #6c757d; }
    .chip { border: 1px solid #e9ecef; background: #fff; }
    .order-meta { font-size: .85rem; color: #6c757d; }
    .table-btn { min-width: 52px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-light">
  <nav class="navbar bg-white border-bottom">
    <div class="container d-flex justify-content-between align-items-center">

    <span class="navbar-brand mb-0 h1">
      {% if restaurant_name %}
        {{ restaurant_name }}
      {% else %}
        S2O • Scan2Order
      {% endif %}
    </span>

      <div class="d-flex align-items-center gap-2">
        <!--QR share -->
        <button class="btn btn-sm btn-outline-primary"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#qrModal">
          QR
        </button>

        <!-- Chọn bàn -->
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                  type="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false">
            Bàn: <b>{{ table_id }}</b>
          </button>

          <ul class="dropdown-menu dropdown-menu-end p-2" style="min-width: 320px;">
            <div class="small-muted mb-2">Chọn bàn</div>

            <div class="d-flex flex-wrap gap-3 small-muted mb-2">
              <span><span class="badge bg-primary"> </span> Đang chọn</span>
              <span><span class="badge bg-warning"> </span> Đang có khách</span>
              <span><span class="badge bg-danger"> </span> Chờ thanh toán</span>
              <span><span class="badge bg-secondary"> </span> Trống</span>
            </div>

            <div class="d-flex flex-wrap gap-2" id="tables-wrap">
              {% for t in tables %}
                {% if t == table_id %}
                  {% set cls = "btn-primary" %}
                {% elif table_status.get(t) == 'billing' %}
                  {% set cls = "btn-danger" %}
                {% elif table_status.get(t) == 'occupied' %}
                  {% set cls = "btn-warning" %}
                {% else %}
                  {% set cls = "btn-outline-primary" %}
                {% endif %}

                <a class="btn btn-sm {{ cls }} table-btn"
                   data-table="{{ t }}"
                   data-selected="{{ '1' if t == table_id else '0' }}"
                   href="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ t }}?q={{ q|urlencode }}&category={{ category|urlencode }}">
                  {{ t }}
                </a>
              {% endfor %}
            </div>
          </ul>
        </div>
      </div>

    </div>
  </nav>

  <main class="container my-3">
    {% set flash = request.session.pop("flash", None) %}
    {% if flash %}
      <div class="alert alert-success">{{ flash }}</div>
    {% endif %}

    <div class="row g-3">
      <!-- Left menu -->
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">

            <!-- Search -->
            <form class="d-flex gap-2 flex-wrap mb-3" method="get">
              <input class="form-control" style="max-width: 360px"
                     name="q" value="{{ q }}" placeholder="Tìm món... (Enter để tìm)"/>
              <input type="hidden" name="category" value="{{ category }}"/>

              <a class="btn btn-outline-secondary"
                 href="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}">Reset</a>

              <a class="btn btn-outline-primary"
                 href="#orders-section">Theo dõi đơn</a>
            </form>

            <!-- Danh mục -->
            <div class="d-flex flex-wrap gap-2">
              <a class="btn btn-sm {% if category=='all' %}btn-primary{% else %}btn-outline-primary{% endif %}"
                 href="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}?q={{ q|urlencode }}&category=all">
                Tất cả
              </a>

              {% for c in categories %}
                <a class="btn btn-sm {% if category==c %}btn-primary{% else %}btn-outline-primary{% endif %}"
                   href="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}?q={{ q|urlencode }}&category={{ c|urlencode }}">
                  {{ c }}
                </a>
              {% endfor %}
            </div>

          </div>
        </div>

        <!-- Menu items -->
        <div class="row g-3 mt-1">
          {% for it in items %}
            <div class="col-md-6">
              <div class="card menu-card">
                {% if it.image_url %}
                  <img src="{{ it.image_url }}" class="card-img-top" alt="{{ it.name }}"/>
                {% endif %}
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <div class="fw-semibold">{{ it.name }}</div>
                      <div class="small-muted">{{ it.category }}</div>
                    </div>
                    <div class="fw-semibold">{{ "{:,}".format(it.price) }}₫</div>
                  </div>

                  {% if it.description %}
                    <div class="mt-2 small-muted">{{ it.description }}</div>
                  {% endif %}

                  <div class="mt-3 d-flex gap-2 align-items-center">
                    {% set ci = cart_map.get(it.id) %}
                    <form method="post" action="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}/cart/sub">
                      <input type="hidden" name="item_id" value="{{ it.id }}"/>
                      <button class="btn btn-outline-secondary btn-sm" type="submit">-</button>
                    </form>

                    <div class="px-2">{{ ci.qty if ci else 0 }}</div>

                    <form method="post" action="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}/cart/add">
                      <input type="hidden" name="item_id" value="{{ it.id }}"/>
                      <button class="btn btn-primary btn-sm" type="submit" {% if not it.available %}disabled{% endif %}>+</button>
                    </form>

                    {% if not it.available %}
                      <span class="badge text-bg-warning">Hết món</span>
                    {% endif %}
                  </div>

                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Right: Cart, bill, orders -->
      <div class="col-lg-4">

        <!-- Cart -->
        <div class="card mb-3">
          <div class="card-header">Giỏ món</div>
          <div class="card-body">
            {% set menu_map = {} %}
            {% for m in menu %}
              {% set _ = menu_map.update({m.id: m}) %}
            {% endfor %}

            {% if not cart %}
              <div class="text-muted">Chưa có món nào trong giỏ.</div>
            {% else %}
              <div class="vstack gap-3">
                {% for ci in cart %}
                  {% set it = menu_map.get(ci.item_id) %}
                  {% if it %}
                    <div class="border rounded-3 p-2 bg-white">
                      <div class="d-flex justify-content-between">
                        <div>
                          <div class="fw-semibold">{{ it.name }}</div>
                          <div class="small-muted">{{ "{:,}".format(it.price) }}₫</div>
                        </div>
                        <div class="text-end">
                          <div class="fw-semibold">x{{ ci.qty }}</div>
                        </div>
                      </div>

                      <div class="d-flex gap-2 mt-2 align-items-center">
                        <form method="post" action="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}/cart/sub">
                          <input type="hidden" name="item_id" value="{{ it.id }}"/>
                          <button class="btn btn-outline-secondary btn-sm" type="submit">-</button>
                        </form>

                        <form method="post" action="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}/cart/add">
                          <input type="hidden" name="item_id" value="{{ it.id }}"/>
                          <button class="btn btn-outline-primary btn-sm" type="submit">+</button>
                        </form>

                        <form class="flex-grow-1 d-flex gap-2" method="post"
                              action="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}/cart/note">
                          <input type="hidden" name="item_id" value="{{ it.id }}"/>
                          <input class="form-control form-control-sm" name="note" value="{{ ci.note or '' }}"
                                 placeholder="Ghi chú (ít đá, không hành...)"/>
                          <button class="btn btn-outline-secondary btn-sm" type="submit">Lưu</button>
                        </form>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}

            <hr class="my-3"/>
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">Tạm tính (giỏ)</div>
              <div class="fw-semibold">{{ "{:,}".format(cart_total) }}₫</div>
            </div>
            <div class="small-muted">Số lượng: {{ cart_qty }} món</div>
          </div>
        </div>

        <!-- Bill (tổng các orders) -->
        {% if bill_paid %}
          {% set bill_badge = "text-bg-success" %}
          {% set bill_label = "Đã thanh toán" %}
        {% elif bill_requested %}
          {% set bill_badge = "text-bg-danger" %}
          {% set bill_label = "Đã gọi thanh toán" %}
        {% else %}
          {% set bill_badge = "text-bg-secondary" %}
          {% set bill_label = "Chưa gọi" %}
        {% endif %}

        <div class="card mb-3" id="bill-section">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Hóa đơn tạm tính</span>
            <span class="badge {{ bill_badge }}" id="bill-status">{{ bill_label }}</span>
          </div>

          <div class="card-body">
            <div id="bill-lines">
              {% if bill_total == 0 %}
                <div class="text-muted">Chưa có món đã đặt.</div>
              {% else %}
                <div class="vstack gap-2">
                  {% for ln in bill_lines %}
                    <div class="d-flex justify-content-between">
                      <div>
                        <div class="fw-semibold">{{ ln.name }}</div>
                        {% if ln.note %}
                          <div class="small-muted">“{{ ln.note }}”</div>
                        {% endif %}
                        <div class="small-muted">
                          {{ "{:,}".format(ln.unit_price) }}₫ x{{ ln.qty }}
                        </div>
                      </div>
                      <div class="fw-semibold">{{ "{:,}".format(ln.subtotal) }}₫</div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <hr class="my-3"/>

            <div class="d-flex justify-content-between">
              <div class="fw-semibold">Tổng</div>
              <div class="fw-semibold" id="bill-total">{{ "{:,}".format(bill_total) }}₫</div>
            </div>
            <div class="small-muted" id="bill-qty">{{ bill_qty }} món</div>

            <div class="small-muted mt-1" id="bill-hint">
              {% if bill_total == 0 %}
                Đặt món xong thì tổng sẽ hiện ở đây để gọi thanh toán.
              {% elif bill_requested %}
                Bạn đã gọi thanh toán, vui lòng chờ thu ngân.
              {% else %}
                Đây là tổng tạm tính dựa trên các đơn đã đặt (kể cả đã phục vụ).
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Orders tracking -->
        <div class="card" id="orders-section">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Theo dõi trạng thái đơn</span>
            <span class="badge text-bg-success" id="orders-conn">Đang theo dõi</span>
          </div>

          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="small-muted" id="orders-last-updated">Chưa cập nhật</div>

              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btn-refresh">
                  Cập nhật
                </button>

                <div class="form-check form-switch m-0">
                  <input class="form-check-input" type="checkbox" role="switch" id="auto-refresh" checked>
                  <label class="form-check-label small-muted" for="auto-refresh">Tự cập nhật</label>
                </div>
              </div>
            </div>

            <div id="orders-container">
              {% if not orders %}
                <div class="text-muted">Chưa có đơn nào.</div>
              {% else %}
                <div class="vstack gap-2">
                  {% for o in orders %}
                    <div class="border rounded-3 p-2 bg-white">
                      <div class="d-flex justify-content-between">
                        <div class="fw-semibold">Đơn #{{ o.id }}</div>
                        <span class="badge text-bg-info">{{ o.status.value }}</span>
                      </div>
                      <div class="small-muted">Tổng: {{ "{:,}".format(o.total) }}₫</div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

          </div>
        </div>

        <!-- Sticky actions -->
        <div class="sticky-actions rounded-3 shadow-sm mt-3">
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="fw-semibold">Tổng hóa đơn</div>
              <div id="sticky-bill-text">{{ "{:,}".format(bill_total) }}₫ • {{ bill_qty }} món</div>
              {% if cart_qty > 0 %}
                <div class="small-muted" id="sticky-cart-text">Giỏ hiện tại: {{ "{:,}".format(cart_total) }}₫ • {{ cart_qty }} món</div>
              {% else %}
                <div class="small-muted d-none" id="sticky-cart-text"></div>
              {% endif %}
            </div>

            <form method="post" action="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}/bill/request">
              <button id="btn-request-bill"
                      class="btn btn-outline-primary"
                      type="submit"
                      {% if bill_total == 0 or bill_requested or bill_paid %}disabled{% endif %}>
                {% if bill_paid %}
                  Đã thanh toán
                {% elif bill_requested %}
                  Đã gọi thanh toán
                {% else %}
                  Gọi thanh toán
                {% endif %}
              </button>
            </form>
          </div>

          <form class="mt-2" method="post" action="/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}/order/place">
            <button class="btn btn-success w-100" type="submit" {% if cart_qty == 0 %}disabled{% endif %}>Đặt món</button>
          </form>
        </div>

      </div>
    </div>
  </main>

  <!-- QR modal -->
  <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">QR Menu • {{ table_id }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="text-center">
            <canvas id="qrCanvas" style="max-width: 100%;"></canvas>
          </div>

          <div class="mt-3">
            <label class="form-label small-muted">Link</label>
            <div class="input-group">
              <input class="form-control mono" id="shareLink" readonly>
              <button class="btn btn-outline-secondary" type="button" id="copyLink">Copy</button>
            </div>
            <div class="small-muted mt-2">
              Mở QR này để bạn bè cùng bàn có thể gọi món chung.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">S2O</strong>
        <small class="text-muted">Thông báo</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="statusToastBody">...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script>
    (function () {
      const ORDERS_URL = "/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}/orders/json";
      const TABLES_URL = "/g/{{ restaurant_id }}/{{ branch_id }}/tables/status/json";
      const SHARE_URL = window.location.origin + "/g/{{ restaurant_id }}/{{ branch_id }}/tables/{{ table_id }}";

      const lastStatus = new Map();

      const elOrders = document.getElementById("orders-container");
      const elLastUpdated = document.getElementById("orders-last-updated");
      const elConn = document.getElementById("orders-conn");
      const btnRefresh = document.getElementById("btn-refresh");
      const autoToggle = document.getElementById("auto-refresh");

      // Bill elements
      const elBillTotal = document.getElementById("bill-total");
      const elBillQty = document.getElementById("bill-qty");
      const elBillLines = document.getElementById("bill-lines");
      const elBillStatus = document.getElementById("bill-status");
      const elStickyBill = document.getElementById("sticky-bill-text");
      const btnBill = document.getElementById("btn-request-bill");

      //  Toast 
      function showToast(msg) {
        const toastEl = document.getElementById("statusToast");
        const bodyEl = document.getElementById("statusToastBody");
        bodyEl.textContent = msg;
        const t = bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 2500 });
        t.show();
      }

      //  Helpers 
      function fmtTime(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "";
        return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      }

      function fmtMoney(n) {
        const x = Number(n || 0);
        return x.toLocaleString("vi-VN") + "₫";
      }

      function escapeHtml(s) {
        return (s ?? "").toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function statusMeta(s) {
        switch (s) {
          case "NEW": return { label: "Mới đặt", badge: "text-bg-secondary", step: 0 };
          case "CONFIRMED": return { label: "Đã xác nhận", badge: "text-bg-primary", step: 1 };
          case "COOKING": return { label: "Đang chuẩn bị", badge: "text-bg-warning", step: 2 };
          case "READY": return { label: "Sẵn sàng", badge: "text-bg-success", step: 3 };
          case "SERVED": return { label: "Đã phục vụ", badge: "text-bg-success", step: 4 };
          case "CANCELLED": return { label: "Đã huỷ", badge: "text-bg-danger", step: -1 };
          default: return { label: String(s || ""), badge: "text-bg-info", step: -1 };
        }
      }

      const steps = ["Mới", "Xác nhận", "Đang làm", "Sẵn sàng", "Phục vụ"];

      function renderSteps(currentStatus) {
        const meta = statusMeta(currentStatus);
        if (meta.step < 0) {
          return `<span class="badge rounded-pill ${meta.badge}">${meta.label}</span>`;
        }
        const cur = meta.step;
        const chips = steps.map((name, i) => {
          let cls = "bg-light text-dark border chip";
          if (i < cur) cls = "text-bg-success";
          if (i === cur) cls = "text-bg-primary";
          return `<span class="badge rounded-pill ${cls}">${name}</span>`;
        }).join(" ");
        return `<div class="d-flex flex-wrap gap-1">${chips}</div>`;
      }

      function renderOrder(o) {
        const meta = statusMeta(o.status);
        const lines = (o.lines || []).map(ln => {
          const note = ln.note ? ` <span class="small-muted">— “${escapeHtml(ln.note)}”</span>` : "";
          return `<li>${escapeHtml(ln.name)} x${ln.qty}${note}</li>`;
        }).join("");

        const total = Number(o.total || 0).toLocaleString("vi-VN");
        const updated = o.updated_at ? `• Cập nhật: ${fmtTime(o.updated_at)}` : "";

        return `
          <div class="border rounded-3 p-2 bg-white">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-semibold">Đơn #${escapeHtml(o.id)}</div>
              <span class="badge ${meta.badge}">${meta.label}</span>
            </div>
            <div class="order-meta">Tổng: ${total}₫ ${updated}</div>
            <div class="mt-2">${renderSteps(o.status)}</div>
            ${lines ? `<ul class="mt-2 mb-0">${lines}</ul>` : ""}
          </div>
        `;
      }

      function billStatusMeta(bill) {
        if (bill && bill.paid) return { label: "Đã thanh toán", badge: "text-bg-success" };
        if (bill && bill.requested) return { label: "Đã gọi thanh toán", badge: "text-bg-danger" };
        if (bill && Number(bill.total || 0) > 0) return { label: "Chưa gọi", badge: "text-bg-secondary" };
        return { label: "Chưa có món", badge: "text-bg-secondary" };
      }

      function renderBillLines(lines) {
        if (!Array.isArray(lines) || lines.length === 0) {
          return `<div class="text-muted">Chưa có món đã đặt.</div>`;
        }
        return `
          <div class="vstack gap-2">
            ${lines.map(ln => {
              const note = ln.note ? `<div class="small-muted">“${escapeHtml(ln.note)}”</div>` : "";
              return `
                <div class="d-flex justify-content-between">
                  <div>
                    <div class="fw-semibold">${escapeHtml(ln.name)}</div>
                    ${note}
                    <div class="small-muted">${fmtMoney(ln.unit_price)} x${ln.qty}</div>
                  </div>
                  <div class="fw-semibold">${fmtMoney(ln.subtotal)}</div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }

      //  Refresh orders, bill 
      async function refreshOrders() {
        try {
          elConn.className = "badge text-bg-secondary";
          elConn.textContent = "Đang cập nhật…";

          const res = await fetch(ORDERS_URL, { headers: { "Accept": "application/json" } });
          if (!res.ok) throw new Error("HTTP " + res.status);

          const data = await res.json();
          const orders = data.orders || [];
          const bill = data.bill || {};

          // Orders UI
          if (orders.length === 0) {
            elOrders.innerHTML = `<div class="text-muted">Chưa có đơn nào.</div>`;
          } else {
            elOrders.innerHTML = `<div class="vstack gap-2">${orders.map(renderOrder).join("")}</div>`;
          }

          // Toast: new order, status change
          for (const o of orders) {
            const prev = lastStatus.get(o.id);
            if (!prev) {
              showToast(`Đã ghi nhận đơn #${o.id} (${statusMeta(o.status).label})`);
            } else if (prev !== o.status) {
              showToast(`Đơn #${o.id}: ${statusMeta(prev).label} → ${statusMeta(o.status).label}`);
            }
            lastStatus.set(o.id, o.status);
          }

          // Bill UI
          const bMeta = billStatusMeta(bill);

          if (elBillStatus) {
            elBillStatus.className = "badge " + bMeta.badge;
            elBillStatus.textContent = bMeta.label;
          }

          if (elBillLines) elBillLines.innerHTML = renderBillLines(bill.lines || []);
          if (elBillTotal) elBillTotal.textContent = fmtMoney(bill.total || 0);
          if (elBillQty) elBillQty.textContent = `${bill.qty || 0} món`;

          if (elStickyBill) {
            elStickyBill.textContent = `${fmtMoney(bill.total || 0)} • ${bill.qty || 0} món`;
          }

          // nút gọi thanh toán
          if (btnBill) {
            const total = Number(bill.total || 0);
            if (bill.paid) {
              btnBill.disabled = true;
              btnBill.textContent = "Đã thanh toán";
            } else if (bill.requested) {
              btnBill.disabled = true;
              btnBill.textContent = "Đã gọi thanh toán";
            } else {
              btnBill.textContent = "Gọi thanh toán";
              btnBill.disabled = total <= 0;
            }
          }

          const nowIso = data.server_time || new Date().toISOString();
          if (elLastUpdated) elLastUpdated.textContent = `Cập nhật lúc ${fmtTime(nowIso)}`;

          elConn.className = "badge text-bg-success";
          elConn.textContent = "Đang theo dõi";
        } catch (err) {
          elConn.className = "badge text-bg-danger";
          elConn.textContent = "Mất kết nối";
        }
      }

      // Refresh table colors 
      async function refreshTables() {
        try {
          const res = await fetch(TABLES_URL, { headers: { "Accept": "application/json" } });
          if (!res.ok) return;
          const data = await res.json();
          const mp = data.tables || {};

          document.querySelectorAll(".table-btn").forEach(btn => {
            const t = btn.dataset.table;
            const selected = btn.dataset.selected === "1";
            if (selected) {
              btn.className = "btn btn-sm btn-primary table-btn";
              return;
            }

            const st = mp[t] || "empty";
            let cls = "btn-outline-primary";
            if (st === "billing") cls = "btn-danger";
            else if (st === "occupied") cls = "btn-warning";

            btn.className = `btn btn-sm ${cls} table-btn`;
          });
        } catch (e) {}
      }

      // Manual refresh
      btnRefresh && btnRefresh.addEventListener("click", async () => {
        await refreshOrders();
        await refreshTables();
      });

      // Initial
      refreshOrders();
      refreshTables();

      // Auto refresh
      setInterval(() => {
        if (autoToggle && autoToggle.checked) {
          refreshOrders();
          refreshTables();
        }
      }, 5000);

      //  QR Modal 
      const qrModal = document.getElementById("qrModal");
      const qrCanvas = document.getElementById("qrCanvas");
      const shareLink = document.getElementById("shareLink");
      const copyBtn = document.getElementById("copyLink");

      if (shareLink) shareLink.value = SHARE_URL;

      qrModal && qrModal.addEventListener("show.bs.modal", () => {
        try {
          if (shareLink) shareLink.value = SHARE_URL;
          if (window.QRCode && qrCanvas) {
            QRCode.toCanvas(qrCanvas, SHARE_URL, { width: 220, margin: 1 }, function (error) {});
          }
        } catch (e) {}
      });

      copyBtn && copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(SHARE_URL);
          showToast("Đã copy link menu.");
        } catch (e) {
          if (shareLink) {
            shareLink.focus();
            shareLink.select();
          }
        }
      });
    })();
  </script>
</body>
</html>
